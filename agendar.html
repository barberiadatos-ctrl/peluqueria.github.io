<script type="module">
  // Importamos la librer√≠a de Supabase
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // üîó Conexi√≥n a tu proyecto Supabase
  const SUPABASE_URL = "https://vukawliizqcjhptpyxdi.supabase.co";
  const SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1a2F3bGlpenFjamhwdHB5eGRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTEwMzksImV4cCI6MjA3Njg4NzAzOX0.XhH_NEwxiEaYqS4vZiWm4DjSXQ1bLZkMtdB0g8ewNtM";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // üíà Lista de precios
  const precios = {
    "Corte sin barba": 10,
    "Corte con barba": 18,
    "Barba sola": 8,
    "Tinte": 15,
    "Peinado": 12,
  };

  let horaSeleccionada = "";

  // === Actualiza el precio seg√∫n el servicio ===
  document.getElementById("servicio").addEventListener("change", () => {
    const servicio = document.getElementById("servicio").value;
    document.getElementById("precio").value = precios[servicio] || "";
  });

  // === Carga los horarios disponibles desde Supabase ===
  document.getElementById("fecha").addEventListener("change", async () => {
    const fecha = document.getElementById("fecha").value;
    if (!fecha) return;

    // Consulta las citas que ya existen en esa fecha
    const { data: citas, error } = await supabase
      .from("citas")
      .select("hora")
      .eq("fecha", fecha);

    if (error) {
      console.error("Error al cargar horarios:", error);
      alert("Error al cargar los horarios.");
      return;
    }

    const ocupados = citas.map((c) => c.hora);
    const lista = document.getElementById("listaHorarios");
    lista.innerHTML = "<h3>Horarios disponibles:</h3>";

    for (let h = 8; h < 22; h++) {
      for (let m of [0, 30]) {
        const hora = `${String(h).padStart(2, "0")}:${m === 0 ? "00" : "30"}`;
        const ocupado = ocupados.includes(hora);
        const div = document.createElement("div");
        div.className = `horario ${ocupado ? "ocupado" : "libre"}`;
        div.textContent = `${hora} ‚Äî ${ocupado ? "Ocupado" : "Libre"}`;
        if (!ocupado) {
          div.addEventListener("click", () => seleccionarHora(hora, div));
        }
        lista.appendChild(div);
      }
    }
  });

  // === Seleccionar hora libre ===
  function seleccionarHora(hora, div) {
    horaSeleccionada = hora;
    document
      .querySelectorAll(".libre")
      .forEach((el) => (el.style.border = "1px solid #ddd"));
    div.style.border = "2px solid green";
  }

  // === Guardar cita en Supabase ===
  const form = document.getElementById("formCita");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!horaSeleccionada) return alert("Selecciona un horario libre");

    const datos = {
      nombre: document.getElementById("nombre").value,
      telefono: document.getElementById("telefono").value,
      servicio: document.getElementById("servicio").value,
      fecha: document.getElementById("fecha").value,
      hora: horaSeleccionada,
      precio: parseFloat(document.getElementById("precio").value || 0),
    };

    const { error } = await supabase.from("citas").insert([datos]);

    if (error) {
      console.error("‚ùå Error al guardar cita:", error);
      alert("‚ùå Error al guardar la cita. Revisa la consola.");
    } else {
      alert("‚úÖ Cita agendada con √©xito!");
      form.reset();
      document.getElementById("listaHorarios").innerHTML = "";
    }
  });
</script>
